var scrapeVar = false;
jQuery.yqlajax = (function (_ajax) {
    var protocol = location.protocol,
        hostname = location.hostname,
        exRegex = RegExp(protocol + "//" + hostname),
        YQL = "http" + (/^https/.test(protocol) ? "s" : "") + "://query.yahooapis.com/v1/public/yql?callback=?",
        query = 'select * from html where url="{URL}" and xpath="*"';

    function isExternal(url) {
        return !exRegex.test(url) && /:\/\//.test(url)
    }
    return function (o) {
        var url = o.url;
        if (/get/i.test(o.type) && !/json/i.test(o.dataType) && isExternal(url)) {
            o.url = YQL;
            o.dataType = "jsonp";
            o.contentType = "application/json";
            o.data = {
                q: query.replace("{URL}", url + (o.data ? (/\?/.test(url) ? "&" : "?") + jQuery.param(o.data) : "")),
                format: "xml"
            };
            if (!o.success && o.complete) {
                o.success = o.complete;
                delete o.complete
            }
            o.success = (function (_success) {
                return function (data) {
                    if (_success) {
                        _success.call(this, {
                            responseText: (data.results[0] || "").replace(/<script[^>]+?\/>|<script(.|\s)*?\/script>/gi, "")
                        }, "success")
                    }
                }
            })(o.success)
        }
        return _ajax.apply(this, arguments)
    }
})(jQuery.ajax);
String.prototype.startsWith = function (str) {
    return (this.match("^" + str) == str)
};
var scrapper_image_width = 100;
var scrapper_image_height = 100;
var imgSrcArray = [];
var imgArrayCounter = 0;
var tid;
var textElement = "";
var displayScrapper = true;

function applyCss() {
    var scrapper_css = {
        "border-top": "1px dashed #e2e2e2",
        width: "100%"
    };
    var scrapper_img_css = {
        "background-position": "center",
        "background-color": "white",
        "background-repeat": "no-repeat",
        "background-size": "contain",
    };
    var scrapper_img_holder_css = {
        padding: "2px",
        margin: "2px"
    };
    var scrapper_img_count_css = {
        "font-size": "10px",
        color: "rgb(127,127,127)",
        "text-align": "center"
    };
    var scrapper_text_holder_css = {
        padding: "2px",
        margin: "2px"
    };
    var scrapper_title_css = {
        "font-weight": "bold",
        "font-size": "14px"
    };
    var button_css = {
        border: "1px solid  rgba(0, 0, 0, 0.5)",
        cursor: "hand",
        cursor: "pointer"
    };
    $("#scrapper_img").css(scrapper_img_css);
    $("#scrapper").css(scrapper_css);
    $("#scrapper_img_holder").css(scrapper_img_holder_css);
    $("#scrapper_img_count").css(scrapper_img_count_css);
    $("#scrapper_text_holder").css(scrapper_text_holder_css);
    $("#scrapper_title").css(scrapper_title_css);
    $("#prevPicButton").css(button_css);
    $("#nextPicButton").css(button_css);
    $("#scrapper_img").css("width", scrapper_image_width + "px");
    $("#scrapper_img").css("height", scrapper_image_height + "px")
}

function scrapeURL(urlText) {
    var regex = /<br\s*[\/]?>/gi;
    urlText = urlText.replace(regex, " ");
    urlText = urlText.replace(/(<([^>]+)>)/ig, " ");
    urlText = $.trim(urlText);
    urlText = urlText.replace("&nbsp;", "");
    var urlexp = new RegExp(/\b(http|https)?(:\/\/)?(\S*)\.(\w{2,4})\b/ig);
    if ($.trim(urlText).toLowerCase() != "http://" && $.trim(urlText).toLowerCase() != "http://www." && $.trim(urlText).toLowerCase() != "http://www" && $.trim(urlText).toLowerCase() != "www" && $.trim(urlText).toLowerCase() != "www.") {
        if (urlText.toLowerCase().indexOf("http://") >= 0) {
            urlString = getUrl("http://", urlText);
            if (urlString.toLowerCase() != "http://www." && urlString.toLowerCase() != "http://www") {
                getUrlData(urlString)
            } else {
                imgSrcArray = [];
                $("#scrapper_img").css({
                    background: "none"
                });
                $("#scrapper_description, #scrapper_title, #scrapper_url").html("");
                $(textElement).parent().find("> img").remove();
                $("#scrapper").hide()
            }
        } else {
            if (urlText.toLowerCase().indexOf("https://") >= 0) {
                urlString = getUrl("https://", urlText);
                getUrlData(urlString)
            } else {
                if (urlText.toLowerCase().indexOf("www") >= 0) {
                    urlString = getUrl("www", urlText);
                    if (urlString.toLowerCase() != "www." && urlString.toLowerCase() != "www") {
                        getUrlData("http://" + urlString)
                    } else {
                        imgSrcArray = [];
                        $("#scrapper_img").css({
                            background: "none"
                        });
                        $("#scrapper_description, #scrapper_title, #scrapper_url").html("");
                        $(textElement).parent().find("> img").remove();
                        $("#scrapper").hide()
                    }
                } else {
                    if (urlexp.test(urlText)) {
                        urlString = urlText.match(urlexp);
                        urlString = urlString[0];
                        getUrlData("http://www." + urlString)
                    } else {
                        imgSrcArray = [];
                        $("#scrapper_img").css({
                            background: "none"
                        });
                        $("#scrapper_description, #scrapper_title, #scrapper_url").html("");
                        $(textElement).parent().find("> img").remove();
                        $("#scrapper").hide()
                    }
                }
            }
        }
    } else {
        imgSrcArray = [];
        $("#scrapper_img").css({
            background: "none"
        });
        $("#scrapper_description, #scrapper_title, #scrapper_url").html("");
        $(textElement).parent().find("> img").remove();
        $("#scrapper").hide()
    }
}

function abortTimer() {
    if (null != tid) {
        clearTimeout(tid)
    }
}
var $scrapperHTML = $('<table id="scrapper"><tr><td><table id="scrapper_img_holder"><tr><td colspan="2" style="height:100px; overflow:hidden;"><div id="scrapper_img"></div></td></tr><tr><td id="" style="width:50%; text-align:right;"><input type="button" id="prevPicButton" value="<"></td><td id="" style="width:50%; text-align:left;"><input type="button" id="nextPicButton" value=">"></td></tr><tr><td colspan="2"><div id="scrapper_img_count"></div></td></tr></table></td><td><table id="scrapper_text_holder"><tr><td ><div id="scrapper_title"></div></td></tr><tr><td ><div id="scrapper_url"></div></td></tr><tr><td ><div id="scrapper_description"></div></td></tr></table></td><td valign="top"></td></tr></table>');
$('.stream-head__forms form div[data-for="link"]').append($scrapperHTML);
$("#scrapper").on("mouseover", function () {
    $(this).find("> tbody > tr > td:last > img").css({
        visibility: "visible"
    })
}).on("mouseleave", function () {
    $(this).find("> tbody > tr > td:last > img").css({
        visibility: "hidden"
    })
});
$("#scrapper > tbody > tr > td:last > img").click(function () {
    $("#scrapper_img").css({
        background: "none"
    });
    $("#scrapper_description, #scrapper_title, #scrapper_url").html("");
    $("#scrapper").hide();
    displayScrapper = false;
    $(textElement).val("")
});
$("#scrapper").hide();
applyCss();
$("#nextPicButton").click(function () {
    imgArrayCounter++;
    if (imgArrayCounter >= imgSrcArray.length) {
        imgArrayCounter = 0
    }
    $("#scrapper_img").css("backgroundImage", "url(" + imgSrcArray[imgArrayCounter] + ")");
    $("#scrapper_img_count").text((imgArrayCounter + 1) + " of " + imgSrcArray.length)
});
$("#prevPicButton").click(function () {
    imgArrayCounter--;
    if (imgArrayCounter < 0) {
        imgArrayCounter = imgSrcArray.length - 1
    }
    $("#scrapper_img").css("backgroundImage", "url(" + imgSrcArray[imgArrayCounter] + ")");
    $("#scrapper_img_count").text((imgArrayCounter + 1) + " of " + imgSrcArray.length)
});

function activateKeyUp(element) {
    textElement = element;
    var frameWindow = $(element).get(0).contentWindow;
    $(frameWindow.document).delegate("body", "keyup", function () {
        disableOrEnableCancelAndSubmitButton("disable");
        urlText = $.trim($(frameWindow.document.body).html());
        if ($(frameWindow.document.body).find("a").length) {
            var urlVal = $(frameWindow.document.body).find("a").text()
        } else {
            var urlVal = $(frameWindow.document.body).text()
        } if (urlVal.indexOf("?") != -1) {
            var baseUrl = urlVal.substr(0, urlVal.indexOf("?"));
            var urlParams = urlVal.substr(urlVal.indexOf("?"));
            if ($(frameWindow.document.body).find("a").length) {
                urlText = '<a target="_blank" href="' + baseUrl.toLowerCase() + urlParams + '">' + baseUrl.toLowerCase() + urlParams + "</a>"
            } else {
                urlText = baseUrl.toLowerCase() + urlParams
            }
        } else {
            urlText.toLowerCase()
        }
        abortTimer();
        tid = setTimeout(function () {
            $(element).parent().css("position", "relative");
            var loaderUrl = '/webresources/images/al/loader.gif';
            if(isNativeUIWebView()){
                loaderUrl = 'webresources/images/al/loader.gif';
            }
            $(element).parent().append('<img src="'+loaderUrl+'" style="position:absolute;right:10px;top:10px;"/>');
            scrapeURL(urlText)
        }, 2000)
    })
}

function getUrl(prefix, urlText) {
    var urlString = "";
    var startIndex = urlText.toLowerCase().indexOf(prefix);
    for (var i = startIndex; i < urlText.length; i++) {
        if (urlText[i] == " " || urlText[i] == "\n") {
            break
        } else {
            urlString += urlText[i]
        }
    }
    return urlString
}

function getUrlData(urlString) {
    if (urlString == "" || urlString == null) {
        imgSrcArray = [];
        $("#scrapper_img").css({
            background: "none"
        });
        $("#scrapper_description, #scrapper_title, #scrapper_url").html("");
        return
    }
    $.yqlajax({
        url: urlString,
        type: "GET",
        success: function (res) {
            if (!scrapeVar) {
                var metaName;
                var metaContent;
                var imgSrc;
                $("#scrapper_description").text("");
                $("#scrapper_title").text("");
                $("#scrapper_url").text("");
                $("#scrapper_img").css("backgroundImage", "");
                imgSrcArray = [];
                imgArrayCounter = 0;
                var htmlString = res.responseText;
                htmlString = htmlString.replace(new RegExp('src=', 'g'),'sourceURL=');
                if (htmlString != "") {
                    var startIndex = htmlString.indexOf("<head>") + 6;
                    var endIndex = htmlString.indexOf("</head>");
                    var headerHTML = htmlString.substring(startIndex, endIndex);
                    var $wrapper = $("<div />").html(headerHTML);
                    var title = "";
                    title = $("title", $wrapper).text();
                    if (title != "") {
                        $("#scrapper_title").html('<a target="_blank" href="' + urlString + '">' + title + "</a>");
                        $("#scrapper_url").html('<a target="_blank" href="' + urlString + '">' + urlString + "</a>");
                        ($wrapper.find("meta")).each(function (index, domElement) {
                            metaName = $(domElement).attr("name");
                            metaProperty = $(domElement).attr("property");
                            metaContent = $(domElement).attr("content");
                            if (metaName == "description" || metaName == "Description") {
                                $("#scrapper_description").text(metaContent)
                            }
                        });
                        $(htmlString).find("img").each(function (index, domElement) {
                            imgSrc = $(domElement).attr("sourceURL");
                            if (imgSrc != null && imgSrc.length > 0) {
                                if (imgSrc.startsWith("//")) {
                                    imgSrc = "http:" + imgSrc
                                } else {
                                    if (imgSrc.startsWith("/")) {
                                    	var url = urlString.match(/([a-z]*:\/\/)?([a-z-_]*)?.?[a-z-_]*.[a-z]*/)
                                        imgSrc = url[0] + imgSrc
                                    } else {
                                        if (!(imgSrc.startsWith("http://") || imgSrc.startsWith("https://"))) {
                                            imgSrc = urlString + "/" + imgSrc
                                        }
                                    }
                                }
                                imgSrcArray.push(imgSrc)
                            }
                        });
                        $("#scrapper_img").css({
                            "background-position": "center",
                            "background-color": "white",
                            "background-repeat": "no-repeat",
                            "background-size": "contain",
                            "background-image": "url(" + imgSrcArray[imgArrayCounter] + ")"
                        });
                        $("#scrapper_img_count").text("1 of " + imgSrcArray.length);
                        $(textElement).parent().find("> img").remove();
                        $("#scrapper").show()
                    }
                } else {
                    imgSrcArray = [];
                    $("#scrapper_description, #scrapper_title, #scrapper_url").html("");
                    $(textElement).parent().find("> img").remove();
                    $("#scrapper").hide();
                    if (res.responseText == "") {
                        $("#scrapper_url").text(urlString)
                    }
                }
                disableOrEnableCancelAndSubmitButton("enable")
            } else {
                scrapeVar = false;
                imgSrcArray = [];
                $("#scrapper_description, #scrapper_title, #scrapper_url").html("");
                $(textElement).parent().find("> img").remove();
                $("#scrapper").hide()
            }
        },
        error: function (err) {
            $(textElement).parent().find("> img").remove();
            $("#scrapper").hide()
        }
    })
};